#!/usr/bin/env node

const path = require('path');
const fs = require('fs');

const bpmnlintrcPath = path.join(process.cwd(), '.bpmnlintrc');


async function run() {

  const argv = process.argv.slice(2);

  const [ arg ] = argv;

  if (arg === '--help') {
    console.log(`usage: bpmnlint-playground [diagram]`);

    return;
  }

  if (!fs.existsSync(bpmnlintrcPath)) {
    console.error(`
  Cannot not find local .bpmnlintrc file, please create one:

    npx bpmnlint --init

  Refer to https://github.com/bpmn-io/bpmnlint#configuration for details.

  Alternatively, run this command in a bpmnlint-plugin folder:

    npx create-bpmnlint-plugin my-plugin

  Refer to https://github.com/nikku/create-bpmnlint-plugin#usage for usage.
  `);

    return process.exit(1);
  }

  if (arg) {

    const relativePath = path.relative(process.cwd(), path.resolve(arg));

    if (relativePath.startsWith('../')) {
      console.error(`diagram <${arg}> must be within working directory`);

      return process.exit(1);
    }

    if (!fs.existsSync(arg)) {
      console.error(`diagram <${arg}> does not exist`);

      return process.exit(1);
    }

  }

  const { run: runPlayground } = require('./playground');

  console.log('Opening playground...');

  return runPlayground(arg);
}


run().catch(err => {
  console.error('failed to start bpmnlint-playground', err);

  process.exit(1);
});